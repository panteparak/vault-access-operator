# Full E2E test stack: k3s (Kubernetes) + Vault (external dev) + Dex (OIDC provider).
# Vault runs as a docker container (not in k8s) to simulate external Vault connectivity.
# Dex gets a network alias so Vault can resolve its OIDC issuer URL via docker DNS.
#
# Usage:
#   make e2e-local-up      # Start everything and configure
#   make e2e-local-test    # Run tests
#   make e2e-local-down    # Tear down

name: vao-e2e

services:
  k3s:
    image: rancher/k3s:v1.30.1-k3s1
    command: >
      server
      --disable=traefik
      --disable=servicelb
      --disable=metrics-server
      --kube-apiserver-arg=service-account-issuer=https://kubernetes.default.svc
      --kube-apiserver-arg=anonymous-auth=true
      --tls-san=k3s
      --tls-san=localhost
      --tls-san=127.0.0.1
      --write-kubeconfig=/output/kubeconfig.yaml
      --write-kubeconfig-mode=644
    privileged: true
    tmpfs:
      - /run
      - /var/run
    volumes:
      - k3s-data:/var/lib/rancher/k3s
      - ./tmp/e2e:/output
    ports:
      - "6443:6443"
    networks:
      - vao-e2e-net
    environment:
      - K3S_TOKEN=e2e-local-token

  vault:
    image: hashicorp/vault:1.21.2
    command:
      - server
      - -dev
      - -dev-root-token-id=root
      - -dev-listen-address=0.0.0.0:8200
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://127.0.0.1:8200"
      VAULT_API_ADDR: "http://127.0.0.1:8200"
      VAULT_TOKEN: "root"
      SKIP_SETCAP: "true"
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    networks:
      - vao-e2e-net
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 5s
      timeout: 3s
      retries: 10

  dex:
    image: ghcr.io/dexidp/dex:v2.39.1
    command: ["dex", "serve", "/etc/dex/config.yaml"]
    volumes:
      - ./test/e2e/fixtures/dex-config.yaml:/etc/dex/config.yaml:ro
    ports:
      - "5556:5556"
    networks:
      vao-e2e-net:
        aliases:
          - dex.default.svc.cluster.local
    depends_on:
      - k3s
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5556/.well-known/openid-configuration"]
      interval: 5s
      timeout: 3s
      retries: 10

networks:
  vao-e2e-net:
    driver: bridge
    name: vao-e2e-net

volumes:
  k3s-data:
    name: vao-e2e-k3s-data
