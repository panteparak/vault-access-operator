name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION_FILE: go.mod
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # Setup: Platform Matrix
  # ============================================================================

  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.platforms.outputs.matrix }}
    steps:
      - name: Set platform matrix
        id: platforms
        run: |
          # Single source of truth for platforms
          # Uncomment the second line and comment the first when ready for arm64
          echo 'matrix=["linux/amd64"]' >> $GITHUB_OUTPUT
          # echo 'matrix=["linux/amd64", "linux/arm64"]' >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 1: Parallel Jobs
  # ============================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - uses: golangci/golangci-lint-action@v8
        with:
          version: v2.1.0
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| golangci-lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - name: Run unit tests
        run: |
          make test 2>&1 | tee test-output.txt
      - name: Generate coverage summary
        if: always()
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage by Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|" >> $GITHUB_STEP_SUMMARY
          grep -E "^ok|coverage:" test-output.txt | \
            sed 's/.*github.com\/panteparak\/vault-access-operator\///' | \
            awk '/^ok/ {pkg=$1} /coverage:/ {print "| " pkg " | " $2 " |"}' >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f cover.out ]; then
            TOTAL=$(go tool cover -func=cover.out | grep total | awk '{print $3}')
            echo "**Total Coverage: ${TOTAL}**" >> $GITHUB_STEP_SUMMARY
          fi
      - uses: codecov/codecov-action@v4
        with:
          files: cover.out
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  verify:
    name: Verify Generated Code & Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Verify generated code
        run: |
          make generate
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Generated code is out of date. Run 'make generate' and commit."
            git diff
            exit 1
          fi

      - name: Verify manifests
        run: |
          make manifests
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Manifests are out of date. Run 'make manifests' and commit."
            git diff
            exit 1
          fi

      - name: Lint Helm chart
        run: |
          helm lint charts/vault-access-operator
          helm template test charts/vault-access-operator --set image.tag=test > /dev/null

      - name: Summary
        if: always()
        run: |
          echo "## âœ… Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Generated code up-to-date | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifests up-to-date | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm chart lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: Docker Build (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [setup]
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.setup.outputs.platforms) }}
    outputs:
      image-tag: sha-${{ steps.short-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Prepare platform vars
        id: platform
        run: |
          platform="${{ matrix.platform }}"
          echo "pair=${platform//\//-}" >> $GITHUB_OUTPUT  # linux/amd64 -> linux-amd64

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Push events: Build and push platform-specific image
      - name: Build and push
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}
          cache-from: type=gha,scope=build-${{ steps.platform.outputs.pair }}
          cache-to: type=gha,scope=build-${{ steps.platform.outputs.pair }},mode=max

      # PRs: Build locally and save for e2e (amd64 only)
      - name: Build for PR
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}
          cache-from: type=gha,scope=build-${{ steps.platform.outputs.pair }}
          cache-to: type=gha,scope=build-${{ steps.platform.outputs.pair }},mode=max

      - name: Save image for PR
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }} \
            -o /tmp/operator-image.tar

      - uses: actions/upload-artifact@v4
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        with:
          name: operator-image
          path: /tmp/operator-image.tar
          retention-days: 1

  docker-manifest:
    name: Docker Manifest
    runs-on: ubuntu-latest
    needs: [setup, docker-build]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          IMAGE_TAG="${{ needs.docker-build.outputs.image-tag }}"

          # Build list of platform-specific images
          IMAGES=""
          for platform in $(echo '${{ needs.setup.outputs.platforms }}' | jq -r '.[]'); do
            pair="${platform//\//-}"
            IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}-${pair}"
          done

          # Create manifest list with multiple tags
          docker buildx imagetools create \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            $IMAGES

      - name: Summary
        run: |
          echo "## ðŸ³ Docker Manifest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Multi-platform manifest created:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Platforms |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ needs.docker-build.outputs.image-tag }}\` | ${{ needs.setup.outputs.platforms }} |" >> $GITHUB_STEP_SUMMARY
          echo "| \`latest\` | ${{ needs.setup.outputs.platforms }} |" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [setup, docker-build]
    permissions:
      contents: read
      packages: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.setup.outputs.platforms) }}
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Prepare platform vars
        id: platform
        run: |
          platform="${{ matrix.platform }}"
          echo "pair=${platform//\//-}" >> $GITHUB_OUTPUT  # linux/amd64 -> linux-amd64

      # For PRs: Load the image from artifact (amd64 only)
      - uses: actions/download-artifact@v4
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        with:
          name: operator-image
          path: /tmp

      - name: Load image (PR)
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        run: docker load -i /tmp/operator-image.tar

      # For push events: Pull from registry
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image (push)
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}

      - name: Set image ref
        id: image
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}" >> $GITHUB_OUTPUT
          fi

      # Skip non-amd64 scans for PRs (no image available)
      - name: Skip scan for non-amd64 PR
        if: github.event_name == 'pull_request' && matrix.platform != 'linux/amd64'
        run: |
          echo "Skipping security scan for ${{ matrix.platform }} on PR (only amd64 image available)"
          echo "## â­ï¸ Security Scan Skipped (${{ matrix.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Non-amd64 scans are skipped for PRs (only amd64 image is built)." >> $GITHUB_STEP_SUMMARY

      # Generate SBOM (CycloneDX format)
      - name: Generate SBOM
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          image-ref: ${{ steps.image.outputs.ref }}
          format: 'cyclonedx'
          output: 'sbom.json'

      # Scan for all vulnerabilities (JSON output)
      - name: Scan for vulnerabilities (JSON - all)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'json'
          output: 'trivy-results.json'
          cache: 'false'

      # Scan for MEDIUM+ vulnerabilities, ignore unfixed (table for summary)
      - name: Scan for vulnerabilities (MEDIUM+, ignore unfixed)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: true
          cache: 'false'

      # Download HTML template and generate report
      - name: Download Trivy HTML template
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o html.tpl

      - name: Generate HTML report
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'template'
          template: '@html.tpl'
          output: 'trivy-report.html'
          severity: 'MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: true
          cache: 'false'

      # Generate SARIF for GitHub Security tab
      - name: Generate SARIF report
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'sarif'
          output: 'trivy-results.sarif'
          cache: 'false'

      - name: Upload SARIF to GitHub Security
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container-scan-${{ steps.platform.outputs.pair }}'

      - name: Upload SBOM
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.platform.outputs.pair }}
          path: sbom.json
          retention-days: 30

      - name: Upload vulnerability report (JSON)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-json-${{ steps.platform.outputs.pair }}
          path: trivy-results.json
          retention-days: 30

      - name: Upload vulnerability report (HTML)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-html-${{ steps.platform.outputs.pair }}
          path: trivy-report.html
          retention-days: 30

      - name: Summary
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        run: |
          echo "## ðŸ”’ Security Scan Results (${{ matrix.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`sbom-${{ steps.platform.outputs.pair }}.json\` | Software Bill of Materials (CycloneDX) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`trivy-results-json-${{ steps.platform.outputs.pair }}.json\` | All vulnerabilities (JSON) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`trivy-report-html-${{ steps.platform.outputs.pair }}.html\` | MEDIUM+ fixable vulnerabilities (HTML) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vulnerability Counts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json 2>/dev/null || echo "0")
          echo "| ðŸ”´ Critical | ${CRITICAL} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | ${HIGH} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | ${MEDIUM} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Low | ${LOW} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Report (MEDIUM+, fixable only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to expand</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Stage 2: Gate
  # ============================================================================

  gate:
    name: Gate
    runs-on: ubuntu-latest
    needs: [lint, unit-test, verify, docker-build, docker-manifest]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Results: lint=${{ needs.lint.result }} test=${{ needs.unit-test.result }} verify=${{ needs.verify.result }} docker=${{ needs.docker-build.result }} manifest=${{ needs.docker-manifest.result }}"
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.unit-test.result }}" != "success" ]] || \
             [[ "${{ needs.verify.result }}" != "success" ]] || \
             [[ "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "::error::One or more required jobs failed"
            exit 1
          fi
          # docker-manifest is skipped for PRs, so check it only if it ran
          if [[ "${{ needs.docker-manifest.result }}" != "success" ]] && \
             [[ "${{ needs.docker-manifest.result }}" != "skipped" ]]; then
            echo "::error::docker-manifest job failed"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš¦ CI Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify | ${{ needs.verify.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.docker-manifest.result }}" != "skipped" ]]; then
            echo "| Docker Manifest | ${{ needs.docker-manifest.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Stage 3: E2E Tests
  # ============================================================================

  e2e:
    name: E2E (${{ matrix.install_method }})
    runs-on: ubuntu-latest
    needs: [gate]
    strategy:
      fail-fast: false
      matrix:
        install_method: [kustomize, helm]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d cluster create e2e --wait --timeout 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=60s

      - name: Deploy Vault
        run: |
          kubectl apply -f test/e2e/fixtures/vault.yaml
          kubectl wait --for=condition=Ready pod/vault-0 -n vault --timeout=300s

      - name: Configure Vault for K8s auth tests
        run: |
          # Create operator policy for bootstrap and token lifecycle tests
          kubectl exec -n vault vault-0 -- vault policy write vault-access-operator - <<'EOF'
          path "sys/policies/acl/*" { capabilities = ["create", "read", "update", "delete", "list"] }
          path "auth/kubernetes/role/*" { capabilities = ["create", "read", "update", "delete", "list"] }
          path "auth/kubernetes/config" { capabilities = ["create", "read", "update", "delete", "list"] }
          path "sys/auth" { capabilities = ["read"] }
          path "sys/auth/*" { capabilities = ["sudo", "create", "read", "update", "delete", "list"] }
          path "sys/mounts" { capabilities = ["read"] }
          EOF
          echo "Vault operator policy created successfully"

      # Load operator image
      - name: Pull image (push)
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}

      - uses: actions/download-artifact@v4
        if: github.event_name == 'pull_request'
        with:
          name: operator-image
          path: /tmp

      - name: Load image (PR)
        if: github.event_name == 'pull_request'
        run: docker load -i /tmp/operator-image.tar

      - name: Load image into k3d
        run: k3d image import ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }} --cluster e2e

      # Deploy operator
      - name: Deploy (kustomize)
        if: matrix.install_method == 'kustomize'
        run: |
          make install
          make deploy IMG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}

      - uses: azure/setup-helm@v4
        if: matrix.install_method == 'helm'
        with:
          version: 'v3.14.0'

      - name: Deploy (helm)
        if: matrix.install_method == 'helm'
        run: |
          helm install vault-access-operator ./charts/vault-access-operator \
            --namespace vault-access-operator-system --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=sha-${{ steps.short-sha.outputs.sha }} \
            --set image.pullPolicy=IfNotPresent \
            --wait --timeout 5m

      - name: Wait for operator
        run: |
          kubectl wait --for=condition=Available deployment \
            -l app.kubernetes.io/name=vault-access-operator \
            -n vault-access-operator-system --timeout=120s

      - name: Run E2E tests
        run: |
          go test ./test/e2e/... -v -ginkgo.v -timeout=10m 2>&1 | tee e2e-output.txt

      - name: E2E Summary
        if: always()
        run: |
          echo "## ðŸš€ E2E Test Results (${{ matrix.install_method }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Install Method | \`${{ matrix.install_method }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | k3d |" >> $GITHUB_STEP_SUMMARY
          echo "| Vault | dev mode |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f e2e-output.txt ]; then
            PASSED=$(grep -c "PASSED" e2e-output.txt || echo "0")
            FAILED=$(grep -c "FAILED" e2e-output.txt || echo "0")
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | ${PASSED} |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | ${FAILED} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Test Output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 e2e-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Collect debug logs
        if: failure()
        run: |
          mkdir -p /tmp/debug-logs
          echo "=== Collecting debug information ==="

          # Pod status
          kubectl get pods -A -o wide > /tmp/debug-logs/pods.txt 2>&1 || true

          # Vault logs and details
          kubectl logs vault-0 -n vault --tail=500 > /tmp/debug-logs/vault-logs.txt 2>&1 || true
          kubectl describe pod vault-0 -n vault > /tmp/debug-logs/vault-describe.txt 2>&1 || true
          kubectl get events -n vault --sort-by='.lastTimestamp' > /tmp/debug-logs/vault-events.txt 2>&1 || true

          # Operator logs and details
          kubectl logs -n vault-access-operator-system -l control-plane=controller-manager --tail=500 > /tmp/debug-logs/operator-logs.txt 2>&1 || true
          kubectl describe pods -n vault-access-operator-system > /tmp/debug-logs/operator-describe.txt 2>&1 || true
          kubectl get events -n vault-access-operator-system --sort-by='.lastTimestamp' > /tmp/debug-logs/operator-events.txt 2>&1 || true

          # CRD status
          kubectl get vaultconnections,vaultpolicies,vaultclusterpolicies,vaultroles,vaultclusterroles -A -o yaml > /tmp/debug-logs/crd-status.yaml 2>&1 || true

          # All events
          kubectl get events -A --sort-by='.lastTimestamp' > /tmp/debug-logs/all-events.txt 2>&1 || true

          # Node info
          kubectl describe nodes > /tmp/debug-logs/nodes.txt 2>&1 || true

          echo "=== Debug logs collected ==="
          ls -la /tmp/debug-logs/

      - name: Upload debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ matrix.install_method }}
          path: /tmp/debug-logs/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: k3d cluster delete e2e || true

  # ============================================================================
  # Stage 4: Success
  # ============================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [e2e]
    steps:
      - run: echo "All CI checks passed!"
