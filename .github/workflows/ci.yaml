name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  GO_VERSION_FILE: go.mod
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # Stage 1: Parallel Jobs
  # ============================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - uses: golangci/golangci-lint-action@v8
        with:
          version: v2.1.0

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - name: Run unit tests
        run: make test
      - uses: codecov/codecov-action@v4
        with:
          files: cover.out
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  verify:
    name: Verify Generated Code & Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Verify generated code
        run: |
          make generate
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Generated code is out of date. Run 'make generate' and commit."
            git diff
            exit 1
          fi

      - name: Verify manifests
        run: |
          make manifests
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Manifests are out of date. Run 'make manifests' and commit."
            git diff
            exit 1
          fi

      - name: Lint Helm chart
        run: |
          helm lint charts/vault-access-operator
          helm template test charts/vault-access-operator --set image.tag=test > /dev/null

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: sha-${{ steps.short-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix=sha-,format=short
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      # Push events: Build and push to registry
      - name: Build and push
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build
          cache-to: type=gha,scope=build,mode=max

      # PRs: Build locally and save for e2e
      - name: Build for PR
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}
          cache-from: type=gha,scope=build
          cache-to: type=gha,scope=build,mode=max

      - name: Save image for PR
        if: github.event_name == 'pull_request'
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }} \
            -o /tmp/operator-image.tar

      - uses: actions/upload-artifact@v4
        if: github.event_name == 'pull_request'
        with:
          name: operator-image
          path: /tmp/operator-image.tar
          retention-days: 1

  # ============================================================================
  # Stage 2: Gate
  # ============================================================================

  gate:
    name: Gate
    runs-on: ubuntu-latest
    needs: [lint, unit-test, verify, docker-build]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Results: lint=${{ needs.lint.result }} test=${{ needs.unit-test.result }} verify=${{ needs.verify.result }} docker=${{ needs.docker-build.result }}"
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.unit-test.result }}" != "success" ]] || \
             [[ "${{ needs.verify.result }}" != "success" ]] || \
             [[ "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "::error::One or more required jobs failed"
            exit 1
          fi

  # ============================================================================
  # Stage 3: E2E Tests
  # ============================================================================

  e2e:
    name: E2E (${{ matrix.install_method }})
    runs-on: ubuntu-latest
    needs: [gate]
    strategy:
      fail-fast: false
      matrix:
        install_method: [kustomize, helm]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup kind
        run: |
          curl -sLo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          kind create cluster --name e2e --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=60s

      - name: Deploy Vault
        run: |
          kubectl apply -f test/e2e/fixtures/vault.yaml
          kubectl wait --for=condition=Ready pod/vault-0 -n vault --timeout=180s

      - name: Configure Vault for K8s auth tests
        run: |
          # Create operator policy for bootstrap and token lifecycle tests
          kubectl exec -n vault vault-0 -- vault policy write vault-access-operator - <<'EOF'
          path "sys/policies/acl/*" {
            capabilities = ["create", "read", "update", "delete", "list"]
          }
          path "auth/kubernetes/role/*" {
            capabilities = ["create", "read", "update", "delete", "list"]
          }
          path "auth/kubernetes/config" {
            capabilities = ["create", "read", "update", "delete", "list"]
          }
          path "sys/auth" {
            capabilities = ["read"]
          }
          path "sys/auth/*" {
            capabilities = ["sudo", "create", "read", "update", "delete", "list"]
          }
          path "sys/mounts" {
            capabilities = ["read"]
          }
          EOF
          echo "Vault operator policy created successfully"

      # Load operator image
      - name: Pull image (push)
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}

      - uses: actions/download-artifact@v4
        if: github.event_name == 'pull_request'
        with:
          name: operator-image
          path: /tmp

      - name: Load image (PR)
        if: github.event_name == 'pull_request'
        run: docker load -i /tmp/operator-image.tar

      - name: Load image into kind
        run: kind load docker-image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }} --name e2e

      # Deploy operator
      - name: Deploy (kustomize)
        if: matrix.install_method == 'kustomize'
        run: |
          make install
          make deploy IMG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}

      - uses: azure/setup-helm@v4
        if: matrix.install_method == 'helm'
        with:
          version: 'v3.14.0'

      - name: Deploy (helm)
        if: matrix.install_method == 'helm'
        run: |
          helm install vault-access-operator ./charts/vault-access-operator \
            --namespace vault-access-operator-system --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=sha-${{ steps.short-sha.outputs.sha }} \
            --set image.pullPolicy=IfNotPresent \
            --wait --timeout 5m

      - name: Wait for operator
        run: |
          kubectl wait --for=condition=Available deployment \
            -l app.kubernetes.io/name=vault-access-operator \
            -n vault-access-operator-system --timeout=120s

      - name: Run E2E tests
        run: go test ./test/e2e/... -v -ginkgo.v -timeout=10m

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Operator Logs ===" && kubectl logs -n vault-access-operator-system -l control-plane=controller-manager --tail=200 || true
          echo "=== Vault Logs ===" && kubectl logs vault-0 -n vault --tail=50 || true
          echo "=== CRD Status ===" && kubectl get vaultconnections,vaultpolicies,vaultclusterpolicies,vaultroles,vaultclusterroles -A || true
          echo "=== Events ===" && kubectl get events -A --sort-by='.lastTimestamp' | tail -50 || true
          echo "=== Pods ===" && kubectl get pods -A || true

      - name: Cleanup
        if: always()
        run: kind delete cluster --name e2e || true

  # ============================================================================
  # Stage 4: Success
  # ============================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [e2e]
    steps:
      - run: echo "All CI checks passed!"
