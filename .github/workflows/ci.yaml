name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Cancel in-progress runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION_FILE: go.mod
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # Setup: Platform Matrix
  # ============================================================================

  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.platforms.outputs.matrix }}
    steps:
      - name: Set platform matrix
        id: platforms
        run: |
          # Single source of truth for platforms
          # Uncomment the second line and comment the first when ready for arm64
          echo 'matrix=["linux/amd64"]' >> $GITHUB_OUTPUT
          # echo 'matrix=["linux/amd64", "linux/arm64"]' >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 1: Parallel Jobs
  # ============================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - uses: golangci/golangci-lint-action@v8
        with:
          version: v2.8.0
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| golangci-lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - name: Run unit tests
        run: |
          set -o pipefail
          make test 2>&1 | tee test-output.txt
      - name: Generate coverage summary
        if: always()
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage by Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|" >> $GITHUB_STEP_SUMMARY
          grep -E "^ok|coverage:" test-output.txt | \
            sed 's/.*github.com\/panteparak\/vault-access-operator\///' | \
            awk '/^ok/ {pkg=$1} /coverage:/ {print "| " pkg " | " $2 " |"}' >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f cover.out ]; then
            TOTAL=$(go tool cover -func=cover.out | grep total | awk '{print $3}')
            echo "**Total Coverage: ${TOTAL}**" >> $GITHUB_STEP_SUMMARY
          fi
      - uses: codecov/codecov-action@v4
        with:
          files: cover.out
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - name: Run integration tests
        run: |
          # Integration tests require Docker for testcontainers
          # Generate JSON report for detailed test case summary
          go test ./test/integration/... -v -ginkgo.v -ginkgo.show-node-events \
            -ginkgo.json-report=integration-report.json -timeout=10m 2>&1 | tee integration-output.txt || true
      - name: Generate integration test summary
        if: always()
        run: |
          echo "## ðŸ”Œ Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate test case table from JSON report
          if [ -f integration-report.json ]; then
            echo "### Test Cases" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Test Case | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY

            # Parse JSON and create table rows (skip skipped tests)
            jq -r '
              .[] | .SpecReports[]? |
              select(.State != "skipped" and .State != "") |
              (if .State == "passed" then "âœ…" elif .State == "failed" then "âŒ" else "âš ï¸" end) as $status |
              (.LeafNodeText // .ContainerHierarchyTexts[-1] // "Unknown") as $name |
              ((.RunTime / 1000000000 * 100 | floor) / 100) as $duration |
              "| \($status) | \($name) | \($duration)s |"
            ' integration-report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true

            echo "" >> $GITHUB_STEP_SUMMARY

            # Summary counts
            PASSED=$(jq '[.[] | .SpecReports[]? | select(.State == "passed")] | length' integration-report.json 2>/dev/null || echo "0")
            FAILED=$(jq '[.[] | .SpecReports[]? | select(.State == "failed")] | length' integration-report.json 2>/dev/null || echo "0")
            SKIPPED=$(jq '[.[] | .SpecReports[]? | select(.State == "skipped")] | length' integration-report.json 2>/dev/null || echo "0")

            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | âŒ Failed | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-----------|------------|" >> $GITHUB_STEP_SUMMARY
            echo "| ${PASSED} | ${FAILED} | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show failure details if any
          if [ -f integration-output.txt ] && grep -q "FAIL" integration-output.txt; then
            echo "### âŒ Failure Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand failure logs</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -B 5 -A 30 "FAIL\!" integration-output.txt >> $GITHUB_STEP_SUMMARY || tail -100 integration-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Upload integration test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-output
          path: |
            integration-output.txt
            integration-report.json
          retention-days: 7

  verify:
    name: Verify Generated Code & Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Verify generated code
        run: |
          make generate
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Generated code is out of date. Run 'make generate' and commit."
            git diff
            exit 1
          fi

      - name: Verify manifests
        run: |
          make manifests
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Manifests are out of date. Run 'make manifests' and commit."
            git diff
            exit 1
          fi

      - name: Verify Helm CRDs match generated
        run: |
          make helm-update-crds
          if [ -n "$(git status --porcelain charts/)" ]; then
            echo "::error::Helm CRDs are out of date. Run 'make helm-update-crds' and commit."
            git diff charts/
            exit 1
          fi

      - name: Lint Helm chart
        run: |
          helm lint charts/vault-access-operator
          helm template test charts/vault-access-operator --set image.tag=test > /dev/null

      - name: Compare Kustomize and Helm templates
        id: template-compare
        run: |
          echo "## Template Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run comparison and capture output
          if make compare-templates 2>&1 | tee template-compare.txt; then
            echo "âœ… Templates are equivalent" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Template differences found (see details below)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand comparison output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat template-compare.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            # Don't fail the job - this is informational until templates are synced
            echo "::warning::Template differences found between kustomize and helm. Run 'make compare-templates' locally to see details."
          fi

      - name: Summary
        if: always()
        run: |
          echo "## âœ… Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Generated code up-to-date | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Manifests up-to-date | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm chart lint | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Template comparison | ${{ steps.template-compare.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Differences' }} |" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: Docker Build (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [setup]
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.setup.outputs.platforms) }}
    outputs:
      image-tag: sha-${{ steps.short-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Prepare platform vars
        id: platform
        run: |
          platform="${{ matrix.platform }}"
          echo "pair=${platform//\//-}" >> $GITHUB_OUTPUT  # linux/amd64 -> linux-amd64

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Push events: Build and push platform-specific image
      - name: Build and push
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}
          cache-from: type=gha,scope=build-${{ steps.platform.outputs.pair }}
          cache-to: type=gha,scope=build-${{ steps.platform.outputs.pair }},mode=max

      # PRs: Build locally and save for e2e (amd64 only)
      - name: Build for PR
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}
          cache-from: type=gha,scope=build-${{ steps.platform.outputs.pair }}
          cache-to: type=gha,scope=build-${{ steps.platform.outputs.pair }},mode=max

      - name: Save image for PR
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }} \
            -o /tmp/operator-image.tar

      - uses: actions/upload-artifact@v4
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        with:
          name: operator-image
          path: /tmp/operator-image.tar
          retention-days: 1

  docker-manifest:
    name: Docker Manifest
    runs-on: ubuntu-latest
    needs: [setup, docker-build]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          IMAGE_TAG="${{ needs.docker-build.outputs.image-tag }}"

          # Build list of platform-specific images
          IMAGES=""
          for platform in $(echo '${{ needs.setup.outputs.platforms }}' | jq -r '.[]'); do
            pair="${platform//\//-}"
            IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}-${pair}"
          done

          # Create manifest list with multiple tags
          docker buildx imagetools create \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            $IMAGES

      - name: Summary
        run: |
          echo "## ðŸ³ Docker Manifest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Multi-platform manifest created:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Platforms |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ needs.docker-build.outputs.image-tag }}\` | ${{ needs.setup.outputs.platforms }} |" >> $GITHUB_STEP_SUMMARY
          echo "| \`latest\` | ${{ needs.setup.outputs.platforms }} |" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [setup, docker-build]
    permissions:
      contents: read
      packages: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.setup.outputs.platforms) }}
    steps:
      - uses: actions/checkout@v4

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Prepare platform vars
        id: platform
        run: |
          platform="${{ matrix.platform }}"
          echo "pair=${platform//\//-}" >> $GITHUB_OUTPUT  # linux/amd64 -> linux-amd64

      # For PRs: Load the image from artifact (amd64 only)
      - uses: actions/download-artifact@v4
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        with:
          name: operator-image
          path: /tmp

      - name: Load image (PR)
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        run: docker load -i /tmp/operator-image.tar

      # For push events: Pull from registry
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image (push)
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}

      - name: Set image ref
        id: image
        run: |
          # Both PR and push use platform-specific tags for consistency
          echo "ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}-${{ steps.platform.outputs.pair }}" >> $GITHUB_OUTPUT

      # Skip non-amd64 scans for PRs (no image available)
      - name: Skip scan for non-amd64 PR
        if: github.event_name == 'pull_request' && matrix.platform != 'linux/amd64'
        run: |
          echo "Skipping security scan for ${{ matrix.platform }} on PR (only amd64 image available)"
          echo "## â­ï¸ Security Scan Skipped (${{ matrix.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Non-amd64 scans are skipped for PRs (only amd64 image is built)." >> $GITHUB_STEP_SUMMARY

      # Generate SBOM (CycloneDX format)
      - name: Generate SBOM
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          image-ref: ${{ steps.image.outputs.ref }}
          format: 'cyclonedx'
          output: 'sbom.json'

      # Scan for all vulnerabilities (JSON output)
      - name: Scan for vulnerabilities (JSON - all)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'json'
          output: 'trivy-results.json'
          cache: 'false'

      # Scan for MEDIUM+ vulnerabilities, ignore unfixed (table for summary)
      - name: Scan for vulnerabilities (MEDIUM+, ignore unfixed)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: true
          cache: 'false'

      # Download HTML template and generate report
      - name: Download Trivy HTML template
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o html.tpl

      - name: Generate HTML report
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'template'
          template: '@html.tpl'
          output: 'trivy-report.html'
          severity: 'MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: true
          cache: 'false'

      # Generate SARIF for GitHub Security tab
      - name: Generate SARIF report
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'sbom'
          scan-ref: 'sbom.json'
          format: 'sarif'
          output: 'trivy-results.sarif'
          cache: 'false'

      - name: Upload SARIF to GitHub Security
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container-scan-${{ steps.platform.outputs.pair }}'

      - name: Upload SBOM
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.platform.outputs.pair }}
          path: sbom.json
          retention-days: 30

      - name: Upload vulnerability report (JSON)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-json-${{ steps.platform.outputs.pair }}
          path: trivy-results.json
          retention-days: 30

      - name: Upload vulnerability report (HTML)
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report-html-${{ steps.platform.outputs.pair }}
          path: trivy-report.html
          retention-days: 30

      - name: Summary
        if: github.event_name != 'pull_request' || matrix.platform == 'linux/amd64'
        run: |
          echo "## ðŸ”’ Security Scan Results (${{ matrix.platform }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`sbom-${{ steps.platform.outputs.pair }}.json\` | Software Bill of Materials (CycloneDX) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`trivy-results-json-${{ steps.platform.outputs.pair }}.json\` | All vulnerabilities (JSON) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`trivy-report-html-${{ steps.platform.outputs.pair }}.html\` | MEDIUM+ fixable vulnerabilities (HTML) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vulnerability Counts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json 2>/dev/null || echo "0")
          echo "| ðŸ”´ Critical | ${CRITICAL} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | ${HIGH} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | ${MEDIUM} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Low | ${LOW} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Report (MEDIUM+, fixable only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to expand</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Stage 2: Gate
  # ============================================================================

  gate:
    name: Gate
    runs-on: ubuntu-latest
    needs: [lint, unit-test, integration-test, verify, docker-build, docker-manifest]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Results: lint=${{ needs.lint.result }} unit=${{ needs.unit-test.result }} integration=${{ needs.integration-test.result }} verify=${{ needs.verify.result }} docker=${{ needs.docker-build.result }} manifest=${{ needs.docker-manifest.result }}"
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.unit-test.result }}" != "success" ]] || \
             [[ "${{ needs.verify.result }}" != "success" ]] || \
             [[ "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "::error::One or more required jobs failed"
            exit 1
          fi
          # Integration tests are allowed to fail (may need Docker which isn't always available)
          if [[ "${{ needs.integration-test.result }}" != "success" ]] && \
             [[ "${{ needs.integration-test.result }}" != "skipped" ]]; then
            echo "::warning::Integration tests did not pass (may need Docker)"
          fi
          # docker-manifest is skipped for PRs, so check it only if it ran
          if [[ "${{ needs.docker-manifest.result }}" != "success" ]] && \
             [[ "${{ needs.docker-manifest.result }}" != "skipped" ]]; then
            echo "::error::docker-manifest job failed"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš¦ CI Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-test.result == 'success' && 'âœ… Passed' || (needs.integration-test.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warning') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify | ${{ needs.verify.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.docker-manifest.result }}" != "skipped" ]]; then
            echo "| Docker Manifest | ${{ needs.docker-manifest.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Stage 3: Security & Integration Tests
  # ============================================================================

  security-test:
    name: Security Integration Tests
    runs-on: ubuntu-latest
    needs: [gate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - name: Run security tests
        run: |
          # Generate JSON report for detailed test case summary
          go test ./test/integration/security/... -v -ginkgo.v -ginkgo.show-node-events \
            -ginkgo.json-report=security-report.json -timeout=10m 2>&1 | tee security-output.txt || true
      - name: Generate security test summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| SEC-IV | Input Validation (injection, traversal) |" >> $GITHUB_STEP_SUMMARY
          echo "| SEC-RB | RBAC Boundary (namespace isolation) |" >> $GITHUB_STEP_SUMMARY
          echo "| SEC-TLS | TLS/mTLS (certificate handling) |" >> $GITHUB_STEP_SUMMARY
          echo "| SEC-TK | Token Security (lifecycle, revocation) |" >> $GITHUB_STEP_SUMMARY
          echo "| SEC-SH | Secret Handling (no secrets in logs) |" >> $GITHUB_STEP_SUMMARY
          echo "| SEC-PE | Privilege Escalation prevention |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate test case table from JSON report
          if [ -f security-report.json ]; then
            echo "### Test Cases" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Test Case | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY

            # Parse JSON and create table rows (skip skipped tests)
            jq -r '
              .[] | .SpecReports[]? |
              select(.State != "skipped" and .State != "") |
              (if .State == "passed" then "âœ…" elif .State == "failed" then "âŒ" else "âš ï¸" end) as $status |
              (.LeafNodeText // .ContainerHierarchyTexts[-1] // "Unknown") as $name |
              ((.RunTime / 1000000000 * 100 | floor) / 100) as $duration |
              "| \($status) | \($name) | \($duration)s |"
            ' security-report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true

            echo "" >> $GITHUB_STEP_SUMMARY

            # Summary counts
            PASSED=$(jq '[.[] | .SpecReports[]? | select(.State == "passed")] | length' security-report.json 2>/dev/null || echo "0")
            FAILED=$(jq '[.[] | .SpecReports[]? | select(.State == "failed")] | length' security-report.json 2>/dev/null || echo "0")
            SKIPPED=$(jq '[.[] | .SpecReports[]? | select(.State == "skipped")] | length' security-report.json 2>/dev/null || echo "0")

            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | âŒ Failed | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-----------|------------|" >> $GITHUB_STEP_SUMMARY
            echo "| ${PASSED} | ${FAILED} | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show failure details if any
          if [ -f security-output.txt ] && grep -q "FAIL" security-output.txt; then
            echo "### âŒ Failure Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand failure logs</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -B 5 -A 30 "FAIL\!" security-output.txt >> $GITHUB_STEP_SUMMARY || tail -150 security-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Upload security test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-output
          path: |
            security-output.txt
            security-report.json
          retention-days: 7

  integration-profiled:
    name: Integration Tests (Profiled)
    runs-on: ubuntu-latest
    needs: [gate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}
          cache: true
      - name: Run profiled integration tests
        run: |
          make test-integration-report 2>&1 | tee profiled-output.txt || true
      - name: Generate profiling summary
        if: always()
        run: |
          echo "## ðŸ“Š Integration Test Profiling" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Report Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`summary.html\` | Interactive HTML report with test metrics |" >> $GITHUB_STEP_SUMMARY
          echo "| \`metrics.json\` | Machine-readable metrics for CI integration |" >> $GITHUB_STEP_SUMMARY
          echo "| \`*_flamegraph.svg\` | CPU/Memory flamegraphs per test |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/profiling/metrics.json ]; then
            echo "### Suite Metrics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            TOTAL=$(jq -r '.TotalTests // 0' reports/profiling/metrics.json)
            DURATION=$(jq -r '.Duration // 0' reports/profiling/metrics.json)
            PEAK_MEM=$(jq -r '.PeakMemory // 0' reports/profiling/metrics.json)
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | ${DURATION}ns |" >> $GITHUB_STEP_SUMMARY
            echo "| Peak Memory | ${PEAK_MEM} bytes |" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Upload profiling reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: profiling-reports
          path: reports/profiling/
          retention-days: 30

  # ============================================================================
  # Stage 4: E2E Tests
  # ============================================================================

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [gate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set image tag
        id: image-tag
        run: |
          # E2E runs on amd64, so always use linux-amd64 platform tag
          # For PRs: use platform-specific tag (only amd64 is built)
          # For push: use manifest tag (works with multi-arch)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "tag=sha-${{ steps.short-sha.outputs.sha }}-linux-amd64" >> $GITHUB_OUTPUT
          else
            echo "tag=sha-${{ steps.short-sha.outputs.sha }}" >> $GITHUB_OUTPUT
          fi

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup k3d with GHCR access
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

          # Create k3d registry config for GHCR authentication
          mkdir -p /tmp/k3d
          cat > /tmp/k3d/registries.yaml << EOF
          mirrors:
            "ghcr.io":
              endpoint:
                - "https://ghcr.io"
          configs:
            "ghcr.io":
              auth:
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
          EOF

          k3d cluster create e2e --wait --timeout 120s \
            --registry-config /tmp/k3d/registries.yaml \
            --k3s-arg "--disable=traefik@server:*" \
            --k3s-arg "--disable=servicelb@server:*" \
            --k3s-arg "--disable=metrics-server@server:*" \
            --k3s-arg "--kube-apiserver-arg=service-account-issuer=https://kubernetes.default.svc@server:*"
          kubectl wait --for=condition=Ready nodes --all --timeout=60s

      - name: Deploy Vault
        run: |
          kubectl apply -f test/e2e/fixtures/vault.yaml
          # Wait for StatefulSet rollout (handles pod creation timing)
          kubectl rollout status statefulset/vault -n vault --timeout=300s

      - name: Configure Vault for E2E tests
        run: |
          # Create operator policy for E2E tests (supports both Kubernetes and JWT auth)
          # Note: -i flag is required to pass stdin (heredoc) to kubectl exec
          kubectl exec -i -n vault vault-0 -- vault policy write vault-access-operator - <<'EOF'
          # Policy management
          path "sys/policies/acl/*" { capabilities = ["create", "read", "update", "delete", "list"] }
          # Kubernetes auth
          path "auth/kubernetes/role/*" { capabilities = ["create", "read", "update", "delete", "list"] }
          path "auth/kubernetes/config" { capabilities = ["create", "read", "update", "delete", "list"] }
          # JWT auth
          path "auth/jwt/role/*" { capabilities = ["create", "read", "update", "delete", "list"] }
          path "auth/jwt/config" { capabilities = ["create", "read", "update", "delete"] }
          # Auth method management
          path "sys/auth" { capabilities = ["read"] }
          path "sys/auth/*" { capabilities = ["sudo", "create", "read", "update", "delete", "list"] }
          path "sys/mounts" { capabilities = ["read"] }
          EOF
          echo "Vault operator policy created successfully"

          # Enable JWT auth method
          kubectl exec -n vault vault-0 -- vault auth enable jwt || true
          echo "JWT auth method enabled"

          # Get OIDC configuration
          OIDC_CONFIG=$(kubectl get --raw /.well-known/openid-configuration)
          ISSUER=$(echo "$OIDC_CONFIG" | jq -r '.issuer')
          echo "OIDC Issuer: $ISSUER"

          # Try OIDC discovery first (works with internal issuer configured above)
          # Get the Kubernetes CA cert for TLS verification
          K8S_CA=$(kubectl get secret -n vault vault-token -o jsonpath='{.data.ca\.crt}' 2>/dev/null | base64 -d || \
                   kubectl exec -n vault vault-0 -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)

          if kubectl exec -i -n vault vault-0 -- vault write auth/jwt/config \
               oidc_discovery_url="$ISSUER" \
               bound_issuer="$ISSUER" \
               oidc_discovery_ca_pem="$K8S_CA" 2>/dev/null; then
            echo "JWT auth configured with OIDC discovery"
          else
            echo "OIDC discovery failed, falling back to JWKS"
            # Fall back to JWKS (always works, no network call from Vault)
            JWKS=$(kubectl get --raw /openid/v1/jwks)
            kubectl exec -n vault vault-0 -- vault write auth/jwt/config \
              jwt_validation_pubkeys="$JWKS" \
              bound_issuer="$ISSUER" || \
            echo "Warning: JWT auth configuration failed (tests will skip JWT auth)"
          fi

      # For PRs: Load image from artifact (not in registry yet)
      - uses: actions/download-artifact@v4
        if: github.event_name == 'pull_request'
        with:
          name: operator-image
          path: /tmp

      - name: Load image into k3d (PR only)
        if: github.event_name == 'pull_request'
        run: |
          docker load -i /tmp/operator-image.tar
          k3d image import ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }} --cluster e2e

      # Deploy operator using Helm
      # Template comparison in verify job ensures kustomize and helm are equivalent
      - uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Deploy operator (Helm)
        run: |
          helm install vault-access-operator ./charts/vault-access-operator \
            --namespace vault-access-operator-system --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ steps.image-tag.outputs.tag }} \
            --set image.pullPolicy=IfNotPresent \
            --set webhook.enabled=false \
            --wait --timeout 5m

      - name: Wait for operator
        run: |
          kubectl wait --for=condition=Available deployment \
            -l app.kubernetes.io/name=vault-access-operator \
            -n vault-access-operator-system --timeout=120s

      - name: Run E2E tests
        env:
          E2E_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
          E2E_SKIP_BUILD: "true"
          E2E_SKIP_IMAGE_LOAD: "true"
        run: |
          set -o pipefail
          # Run tests with verbose output, timing, and JSON report for detailed summary
          go test ./test/e2e/... -v -ginkgo.v -ginkgo.show-node-events \
            -ginkgo.json-report=e2e-report.json -timeout=10m 2>&1 | tee e2e-output.txt

      - name: E2E Summary
        if: always()
        run: |
          echo "## ðŸš€ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Install Method | Helm |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | k3d |" >> $GITHUB_STEP_SUMMARY
          echo "| Vault | dev mode |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generate test case table from JSON report
          if [ -f e2e-report.json ]; then
            echo "### Test Cases" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Test Case | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY

            # Parse JSON and create table rows (skip skipped tests)
            jq -r '
              .[] | .SpecReports[]? |
              select(.State != "skipped" and .State != "") |
              (if .State == "passed" then "âœ…" elif .State == "failed" then "âŒ" else "âš ï¸" end) as $status |
              (.LeafNodeText // .ContainerHierarchyTexts[-1] // "Unknown") as $name |
              ((.RunTime / 1000000000 * 100 | floor) / 100) as $duration |
              "| \($status) | \($name) | \($duration)s |"
            ' e2e-report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true

            echo "" >> $GITHUB_STEP_SUMMARY

            # Summary counts
            PASSED=$(jq '[.[] | .SpecReports[]? | select(.State == "passed")] | length' e2e-report.json 2>/dev/null || echo "0")
            FAILED=$(jq '[.[] | .SpecReports[]? | select(.State == "failed")] | length' e2e-report.json 2>/dev/null || echo "0")
            SKIPPED=$(jq '[.[] | .SpecReports[]? | select(.State == "skipped")] | length' e2e-report.json 2>/dev/null || echo "0")

            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | âŒ Failed | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-----------|------------|" >> $GITHUB_STEP_SUMMARY
            echo "| ${PASSED} | ${FAILED} | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Extract failures with context
          if [ -f e2e-output.txt ] && grep -q "FAIL" e2e-output.txt; then
            echo "### âŒ Failure Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>Click to expand failure logs</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -B 5 -A 30 "FAIL\!" e2e-output.txt >> $GITHUB_STEP_SUMMARY || tail -100 e2e-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Collect debug logs
        if: failure()
        run: |
          mkdir -p /tmp/debug-logs
          echo "=== Collecting debug information ==="

          # E2E test output
          cp e2e-output.txt /tmp/debug-logs/e2e-output.txt 2>&1 || true

          # Pod status
          kubectl get pods -A -o wide > /tmp/debug-logs/pods.txt 2>&1 || true

          # Vault logs and details
          kubectl logs vault-0 -n vault --tail=500 > /tmp/debug-logs/vault-logs.txt 2>&1 || true
          kubectl describe pod vault-0 -n vault > /tmp/debug-logs/vault-describe.txt 2>&1 || true
          kubectl get events -n vault --sort-by='.lastTimestamp' > /tmp/debug-logs/vault-events.txt 2>&1 || true

          # Operator logs and details
          kubectl logs -n vault-access-operator-system -l control-plane=controller-manager --tail=500 > /tmp/debug-logs/operator-logs.txt 2>&1 || true
          kubectl describe pods -n vault-access-operator-system > /tmp/debug-logs/operator-describe.txt 2>&1 || true
          kubectl get events -n vault-access-operator-system --sort-by='.lastTimestamp' > /tmp/debug-logs/operator-events.txt 2>&1 || true

          # CRD status
          kubectl get vaultconnections,vaultpolicies,vaultclusterpolicies,vaultroles,vaultclusterroles -A -o yaml > /tmp/debug-logs/crd-status.yaml 2>&1 || true

          # All events
          kubectl get events -A --sort-by='.lastTimestamp' > /tmp/debug-logs/all-events.txt 2>&1 || true

          # Node info
          kubectl describe nodes > /tmp/debug-logs/nodes.txt 2>&1 || true

          # Storage (PVCs)
          kubectl get pvc -A -o wide > /tmp/debug-logs/pvcs.txt 2>&1 || true
          kubectl describe pvc -A > /tmp/debug-logs/pvcs-describe.txt 2>&1 || true

          echo "=== Debug logs collected ==="
          ls -la /tmp/debug-logs/

      - name: Upload debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-debug-logs
          path: /tmp/debug-logs/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: k3d cluster delete e2e || true

  # ============================================================================
  # Stage 5: Success
  # ============================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [e2e, security-test, integration-profiled]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "E2E: ${{ needs.e2e.result }}"
          echo "Security: ${{ needs.security-test.result }}"
          echo "Profiled: ${{ needs.integration-profiled.result }}"

          # E2E is required
          if [[ "${{ needs.e2e.result }}" != "success" ]]; then
            echo "::error::E2E tests failed"
            exit 1
          fi

          # Security and profiled tests are informational
          if [[ "${{ needs.security-test.result }}" != "success" ]] && \
             [[ "${{ needs.security-test.result }}" != "skipped" ]]; then
            echo "::warning::Security tests did not pass"
          fi
          if [[ "${{ needs.integration-profiled.result }}" != "success" ]] && \
             [[ "${{ needs.integration-profiled.result }}" != "skipped" ]]; then
            echo "::warning::Profiled integration tests did not pass"
          fi

          echo "All CI checks passed!"

      - name: Final Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ CI Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Stage 4 | E2E Tests | ${{ needs.e2e.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stage 3 | Security Tests | ${{ needs.security-test.result == 'success' && 'âœ… Passed' || (needs.security-test.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warning') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stage 3 | Profiled Tests | ${{ needs.integration-profiled.result == 'success' && 'âœ… Passed' || (needs.integration-profiled.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warning') }} |" >> $GITHUB_STEP_SUMMARY
